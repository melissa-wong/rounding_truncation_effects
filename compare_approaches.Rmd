---
title: "Compare Approaches"
author: "Melissa Wong"
date: "12/15/2021"
output: html_document
---

# Setup

```{r libraries, results='hide', message=FALSE, warning=FALSE}

library(tidyverse)
library(broom)
library(RColorBrewer)
library(here)
```

```{r options}
options("scipen" = 1, "digits" = 4)

#knitr::opts_chunk$set(echo = FALSE)
#knitr::opts_chunk$set(message = FALSE)
#knitr::opts_chunk$set(warning = FALSE)
#knitr::opts_chunk$set(out.width = "50%")
#knitr::opts_chunk$set(fig.align = "center")

set.seed(1234)
```

# Simulate Data

```{r}

# Proportion of rounded/truncated data
prop <- seq(0.1, 0.9, 0.1)

N <- c(25, 100, 500, 1000)

params <- expand.grid(prop=prop, N=N)

alpha_true = -1
beta_true = 1
sigma_true = 1

sidx <- apply(params, 1, function(p) sample(1:p[2], p[2] * p[1], replace=FALSE))

df <-lapply(1:length(sidx), function(i) {
  tmp <- data.frame(x = rnorm(params[i, "N"], 0, 5),
                    prop = params[i, "prop"],
                    n = params[i, "N"]) %>%
  mutate(y_true = alpha_true + beta_true*x + rnorm(params[i, "N"], 0, sigma_true),
         y_round = y_true,
         y_trunc = y_true,
         iflag = 0
  )
  # Simulate a "mixture" with some subset of the data truncated/rounded
  tmp$y_round[sidx[[i]]] <- round(tmp$y_round[sidx[[i]]])
  tmp$y_trunc[sidx[[i]]] <- trunc(tmp$y_trunc[sidx[[i]]])
  tmp$iflag[sidx[[i]]] <- 1
  tmp
})

# Convert list to tidy dataframe
df_tidy <- do.call(rbind.data.frame, df)
```


```{r eval=FALSE, include=FALSE}
for (i in seq_along(N)) {
  print(
    df_tidy %>%
      filter(n==N[i]) %>%
      select(-iflag) %>% 
      pivot_longer(-c("x", "prop", "n"), names_to="data") %>%
      ggplot() +
      geom_point(aes(x=x, y=value, color=data), 
               alpha=0.2) +
      facet_grid(prop ~ data) +
      labs(title=paste("Sample Size =", N[i]))
  )
}
```

# Reference Distribution Known

## Two-Sample Kolmogorv-Smirnoff Test

```{r warning=FALSE}

# Test proportion of rounding
ks_round <- df_tidy %>% 
  group_by(prop, n) %>% 
  summarise(tidy(ks.test(y_true, y_round))) %>% 
  ungroup() %>%
  mutate(method="Two-sample KS test, y_true vs. y_round")

ks_trunc <- df_tidy %>% 
  group_by(prop, n) %>% 
  summarise(tidy(ks.test(y_true, y_trunc))) %>% 
  ungroup() %>%
  mutate(method="Two-sample KS test, y_true vs. y_trunc")

rbind(ks_round, ks_trunc) %>% 
  ggplot(mapping=aes(x=prop, 
                        y=p.value, 
                        color=factor(n))) +
  geom_point() +
  geom_line() +
  geom_hline(mapping=aes(yintercept=0.05),
             color="red",
             linetype="dashed") +
  scale_x_continuous(breaks=prop) +
  labs(x="Proportion of truncated data",
       color="Number of Obs") +
  facet_grid(~method)
```

For $\alpha=0.05$:

* The KS test fails to reject the null hypothesis that the samples are drawn from the same distribution for all simulated rounded data cases .

* The KS rejects the null when the sample size is large (>500 obs) and the proportion truncated is high (>0.7) for the simulated truncated data cases.

# Family of Distribution Known

In reality, we don't know the exact reference distribution but we can reasonably assume it is Normal.

# One-Sample Kolmogorv-Smirnov Test

```{r warning=FALSE}

# Test proportion of rounding
ks1_round <- df_tidy %>% 
  group_by(prop, n) %>% 
  summarise(tidy(ks.test(y_round, "pnorm", mean=mean(y_round), sd=sd(y_round)))) %>% 
  ungroup() %>%
  mutate(method="One-sample KS test, y_round")

ks1_trunc <- df_tidy %>% 
  group_by(prop, n) %>% 
  summarise(tidy(ks.test(y_trunc, "pnorm", mean=mean(y_trunc), sd=sd(y_trunc)))) %>% 
  ungroup() %>%
  mutate(method="One-sample KS test, y_trunc")

rbind(ks1_round, ks1_trunc) %>% 
  ggplot(mapping=aes(x=prop, 
                        y=p.value, 
                        color=factor(n))) +
  geom_point() +
  geom_line() +
  geom_hline(mapping=aes(yintercept=0.05),
             color="red",
             linetype="dashed") +
  scale_x_continuous(breaks=prop) +
  labs(x="Proportion of truncated data",
       color="Number of Obs") +
  facet_grid(~method)
```

# Shapiro-Wilk Test

Another alternative is the Shapiro-Wilk test, the advantage being that it is more powerful than the Kolmogorov-Smirnov test for testing Normality.

```{r}
sw_round <- df_tidy %>% 
  group_by(prop, n) %>% 
  summarise(tidy(shapiro.test(y_round))) %>% 
  ungroup() %>% 
  mutate(method="Shapiro-Wilk test, y_round")

sw_trunc <- df_tidy %>% 
  group_by(prop, n) %>% 
  summarise(tidy(shapiro.test(y_trunc))) %>% 
  ungroup() %>% 
  mutate(method="Shapiro-Wilk test, y_trunc")

rbind(sw_round, sw_trunc) %>% 
  ggplot(mapping=aes(x=prop, 
                        y=p.value, 
                        color=factor(n))) +
  geom_point() +
  geom_line() +
  geom_hline(mapping=aes(yintercept=0.05),
             color="red",
             linetype="dashed") +
  scale_x_continuous(breaks=prop) +
  labs(x="Proportion of rounded data",
       color="Number of Obs") +
  facet_grid(~method)

```

# Bayesian Models

```{r}

```


